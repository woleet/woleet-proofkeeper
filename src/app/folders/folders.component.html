<div class="card">
  <div class="flex-tab align-to-btn">
    <div class="fill-max-content">
      <a
        class="custom-tab-button"
        [ngClass]="{ active: isOnAnchorTab() }"
        (click)="changeTab()"
      >
        <i class="icon icon-clock"></i>
        <span class="ml-1">{{
          translations.folders.tabs.filesToTimestamp | translate
        }}</span>
      </a>
      <a
        class="custom-tab-button"
        [ngClass]="{ active: isOnSignTab() }"
        (click)="changeTab()"
      >
        <i class="icon icon-seal"></i>
        <span class="ml-1">{{
          translations.folders.tabs.filesToSeal | translate
        }}</span>
      </a>

      <hr class="hr-tab" />
    </div>
    <button
      class="btn btn-primary align-btn-content"
      [disabled]="addState"
      (click)="onAddFolderClick()"
    >
      <i class="icon-add mr"></i>
      {{ translations.folders.newFolder | translate }}
    </button>
  </div>
  <form [formGroup]="folderFormGroup" *ngIf="addState">
    <mat-form-field class="full-width">
      <mat-label>{{ translations.folders.folderToScan | translate }}</mat-label>
      <input matInput type="text" formControlName="path" />
      <button
        *ngIf="folderFormGroup.get('path').value"
        (click)="resetPath()"
        class="btn btn-without-background"
      >
        <i class="icon-close mr"></i>
      </button>
      <button class="btn btn-primary" (click)="onClickPopUpDirectory()">
        {{ translations.folders.chooseFolder | translate }}
      </button>
      <mat-error *ngIf="folderFormGroup.get('path').getError('collidingPaths')">
        {{ translations.folders.errors.folderAlreadyPresent | translate }}
      </mat-error>
    </mat-form-field>
    <div *ngIf="folderFormGroup.get('action').value == 'sign'">
      <mat-form-field>
        <mat-label>{{
          translations.folders.identityToUse | translate
        }}</mat-label>
        <mat-select
          class="custom-select"
          formControlName="identity"
          name="identity"
        >
          <mat-option
            *ngFor="let identityName of identityService.arrayIdentityContent"
            [value]="identityName.name"
          >
            {{ identityName.name }}
          </mat-option>
        </mat-select>
        <mat-error *ngIf="identityService.arrayIdentityContent.length === 0">
          {{ translations.folders.errors.addAtLeastOneIdentity | translate }}
        </mat-error>
        <mat-error
          *ngIf="
            identityService.arrayIdentityContent.length !== 0 &&
            folderFormGroup.get('identity').getError('voidIdentity')
          "
        >
          {{ translations.folders.errors.identityRequired | translate }}
        </mat-error>
        <mat-error
          *ngIf="folderFormGroup.get('identity').getError('identityNotFound')"
        >
          {{ translations.folders.errors.notFound | translate }}
        </mat-error>
      </mat-form-field>
    </div>
    <br />

    <label class="checkbox-content">
      <input type="checkbox" formControlName="public" />
      {{ translations.folders.checkbox.makeProofsPublicly | translate }}
    </label>

    <label class="checkbox-content">
      <input type="checkbox" formControlName="recursive" />
      {{ translations.folders.checkbox.includeFilesFromSubfolders | translate }}
    </label>

    <label class="checkbox-content">
      <input type="checkbox" formControlName="strict" />
      {{ translations.folders.checkbox.recreateProofs | translate }}
    </label>

    <label class="checkbox-content">
      <input type="checkbox" formControlName="prune" />
      {{ translations.folders.checkbox.deleteOldProofs | translate }}
    </label>

    <label
      *ngIf="folderFormGroup.controls['action'].value === 'sign'"
      class="checkbox-content"
    >
      <input type="checkbox" formControlName="iDServerUnsecureSSL" />
      {{ translations.folders.checkbox.notCheckSSLCertificate | translate }}
    </label>

    <div>
      <mat-form-field class="full-width">
        <mat-label>{{
          translations.folders.proveFilesMatchingRegularExpression | translate
        }}</mat-label>
        <input
          matInput
          class="form-control"
          type="text"
          name="filter"
          formControlName="filter"
        />
      </mat-form-field>
    </div>
    <span class="align-end">
      <button
        class="btn btn-primary mr"
        [disabled]="folderFormGroup.invalid"
        (click)="onClickAdd()"
      >
        {{ translations.folders.addFolder | translate }}
      </button>
      <button class="btn btn-danger" (click)="onCancelAddClick()">
        {{ translations.commons.buttons.cancel | translate }}
      </button>
    </span>
  </form>
  <br />
  <div class="watchedFolders">
    <mat-accordion>
      <ng-container *ngFor="let folderForm of foldersFormGroup; let i = index">
        <mat-expansion-panel
          *ngIf="
            folderForm.get('action').value ===
            folderFormGroup.get('action').value
          "
        >
          <mat-expansion-panel-header>
            <div class="span-expansion-panel-header">
              <span class="span-folder-name">{{
                folderForm.get('path').value
              }}</span>
              <div class="btn-on-right">
                <div
                  class="state mr"
                  [class]="getStatusColor(i)"
                  [appTooltip]="getStatusTooltip(i)"
                  (click)="$event.stopPropagation(); onClickRefresh(folderForm)"
                ></div>
                <button
                  class="btn btn-danger btn-without-background"
                  [appTooltip]="
                    translations.folders.tooltips.deleteFolder | translate
                  "
                  (click)="
                    $event.stopPropagation();
                    openConfirmDialog = true;
                    folderFormSelectedForDeletion = folderForm
                  "
                >
                  <i class="icon-trash trash-btn"></i>
                </button>
              </div>
            </div>
          </mat-expansion-panel-header>
          <form [formGroup]="folderForm">
            <div *ngIf="folderForm.get('action').value === 'sign'">
              <mat-form-field>
                <mat-select
                  class="custom-select"
                  formControlName="identity"
                  name="identity"
                  placeholder="Identity to use"
                >
                  <mat-option
                    *ngFor="
                      let identityName of identityService.arrayIdentityContent
                    "
                    [value]="identityName.name"
                  >
                    {{ identityName.name }}
                  </mat-option>
                </mat-select>
                <mat-error
                  *ngIf="identityService.arrayIdentityContent.length === 0"
                >
                  {{
                    translations.folders.errors.addAtLeastOneIdentity
                      | translate
                  }}
                </mat-error>
                <mat-error
                  *ngIf="
                    identityService.arrayIdentityContent.length !== 0 &&
                    folderForm.get('identity').getError('voidIdentity')
                  "
                >
                  {{ translations.folders.errors.identityRequired | translate }}
                </mat-error>
                <mat-error
                  *ngIf="
                    folderForm.get('identity').getError('identityNotFound')
                  "
                >
                  {{ translations.folders.errors.notFound | translate }}
                </mat-error>
              </mat-form-field>
            </div>
            <div
              *ngIf="
                folderForm.get('action').value ===
                folderFormGroup.get('action').value
              "
            >

            <label class="checkbox-content">
              <input type="checkbox" formControlName="public" />
              {{ translations.folders.checkbox.makeProofsPublicly | translate }}
            </label>

            <label class="checkbox-content">
              <input type="checkbox" formControlName="recursive" />
              {{ translations.folders.checkbox.includeFilesFromSubfolders | translate }}
            </label>

            <label class="checkbox-content">
              <input type="checkbox" formControlName="strict" />
              {{ translations.folders.checkbox.recreateProofs | translate }}
            </label>

            <label class="checkbox-content">
              <input type="checkbox" formControlName="prune" />
              {{ translations.folders.checkbox.deleteOldProofs | translate }}
            </label>

            <label *ngIf="folderForm.get('action').value === 'sign'" class="checkbox-content">
              <input type="checkbox" formControlName="iDServerUnsecureSSL" />
              {{ translations.folders.checkbox.notCheckSSLCertificate | translate }}
            </label>
              <div>
                <mat-form-field class="full-width">
                  <mat-label>{{
                    translations.folders.proveFilesMatchingRegularExpression
                      | translate
                  }}</mat-label>
                  <input
                    matInput
                    class="form-control"
                    type="text"
                    name="filter"
                    formControlName="filter"
                  />
                </mat-form-field>
              </div>
            </div>
            <div>
              <button
                class="btn btn-primary mr"
                (click)="onClickFixReceipts(folderForm)"
              >
                {{ translations.folders.fixReceipts | translate }}
              </button>
              {{ translations.folders.renameOldReceiptsAndFix | translate }}
            </div>
            <span class="span-update-configuration">
              <button
                class="btn btn-primary"
                [disabled]="folderForm.pristine || folderForm.invalid"
                (click)="onClickUpdateFolderOptions(folderForm)"
              >
                {{ translations.folders.updateConfig | translate }}
              </button>
            </span>
          </form>
        </mat-expansion-panel>
      </ng-container>
    </mat-accordion>
  </div>
</div>

<app-confirmation-dialog
  *ngIf="openConfirmDialog"
  [confirmationTitle]="translations.folders.removeFolder | translate"
  [confirmationText]="translations.folders.removeFolderQuestion | translate"
  (exitDialog)="onExitDialog($event)"
></app-confirmation-dialog>
