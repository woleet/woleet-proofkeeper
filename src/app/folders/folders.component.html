<div class="card">
  <button
    mat-fab
    color="primary"
    class="folder-add-button"
    [disabled]="addState"
    (click)="onAddFolderClick()"
  >
    <mat-icon [inline]="true" [style.font-size.px]="48">add</mat-icon>
  </button>
  <div class="tab-flex">
    <a
      class="custom-tab-button"
      [ngClass]="{ active: isOnAnchorTab() }"
      (click)="changeTab()"
    >
      <i class="icon icon-clock"></i>
      <span class="ml-1">{{
        translations.folders.tabs.filesToTimestamp | translate
      }}</span>
    </a>
    <a
      class="custom-tab-button"
      [ngClass]="{ active: isOnSignTab() }"
      (click)="changeTab()"
    >
      <i class="icon icon-seal"></i>
      <span class="ml-1">{{
        translations.folders.tabs.filesToSeal | translate
      }}</span>
    </a>
  </div>
  <hr class="hr-tab" />

  <form [formGroup]="folderFormGroup" *ngIf="addState">
    <mat-form-field class="full-width">
      <mat-label>{{ translations.folders.folderToScan | translate }}</mat-label>
      <input matInput type="text" formControlName="path" />
      <button
        *ngIf="folderFormGroup.get('path').value"
        (click)="resetPath()"
        class="btn btn-without-background"
      >
        <i class="icon-close"></i>
      </button>
      <button class="btn btn-primary" (click)="onClickPopUpDirectory()">
        {{ translations.folders.chooseFolder | translate }}
      </button>
      <mat-error *ngIf="folderFormGroup.get('path').getError('collidingPaths')">
        {{ translations.folders.errors.folderAlreadyPresent | translate }}
      </mat-error>
    </mat-form-field>
    <div *ngIf="folderFormGroup.get('action').value == 'sign'">
      <mat-form-field>
        <mat-label>{{
          translations.folders.identityToUse | translate
        }}</mat-label>
        <mat-select
          class="custom-select"
          formControlName="identity"
          name="identity"
        >
          <mat-option
            *ngFor="let identityName of identityService.arrayIdentityContent"
            [value]="identityName.name"
          >
            {{ identityName.name }}
          </mat-option>
        </mat-select>
        <mat-error *ngIf="identityService.arrayIdentityContent.length === 0">
          {{ translations.folders.errors.addAtLeastOneIdentity | translate }}
        </mat-error>
        <mat-error
          *ngIf="
            identityService.arrayIdentityContent.length !== 0 &&
            folderFormGroup.get('identity').getError('voidIdentity')
          "
        >
          {{ translations.folders.errors.identityRequired | translate }}
        </mat-error>
        <mat-error
          *ngIf="folderFormGroup.get('identity').getError('identityNotFound')"
        >
          {{ translations.folders.errors.notFound | translate }}
        </mat-error>
      </mat-form-field>
    </div>
    <br />
    <div>
      <mat-checkbox color="primary" name="public" formControlName="public">
        {{ translations.folders.checkbox.makeProofsPublicly | translate }}
      </mat-checkbox>
    </div>
    <div>
      <mat-checkbox
        color="primary"
        name="recursive"
        formControlName="recursive"
      >
        {{
          translations.folders.checkbox.includeFilesFromSubfolders | translate
        }}
      </mat-checkbox>
    </div>
    <div>
      <mat-checkbox color="primary" name="strict" formControlName="strict">
        {{ translations.folders.checkbox.recreateProofs | translate }}
      </mat-checkbox>
    </div>
    <div>
      <mat-checkbox color="primary" name="prune" formControlName="prune">
        {{ translations.folders.checkbox.deleteOldProofs | translate }}
      </mat-checkbox>
    </div>
    <div *ngIf="folderFormGroup.controls['action'].value === 'sign'">
      <mat-checkbox
        color="primary"
        name="iDServerUnsecureSSL"
        formControlName="iDServerUnsecureSSL"
      >
        {{ translations.folders.checkbox.notCheckSSLCertificate | translate }}
      </mat-checkbox>
    </div>
    <div>
      <mat-form-field class="full-width">
        <mat-label>{{
          translations.folders.proveFilesMatchingRegularExpression | translate
        }}</mat-label>
        <input
          matInput
          class="form-control"
          type="text"
          name="filter"
          formControlName="filter"
        />
      </mat-form-field>
    </div>
    <span class="align-end">
      <button
        class="btn btn-primary mr"
        [disabled]="folderFormGroup.invalid"
        (click)="onClickAdd()"
      >
        {{ translations.folders.addFolder | translate }}
      </button>
      <button class="btn danger" (click)="onCancelAddClick()">
        {{ translations.commons.buttons.cancel | translate }}
      </button>
    </span>
  </form>
  <br />
  <div class="watchedFolders">
    <mat-accordion>
      <ng-container *ngFor="let folderForm of foldersFormGroup; let i = index">
        <mat-expansion-panel
          *ngIf="
            folderForm.get('action').value ===
            folderFormGroup.get('action').value
          "
        >
          <mat-expansion-panel-header>
            <div class="span-expansion-panel-header">
              <span class="span-folder-name">{{
                folderForm.get('path').value
              }}</span>
              <div class="btn-on-right">
                <div
                  class="state mr"
                  [class]="getStatusColor(i)"
                  [appTooltip]="getStatusTooltip(i)"
                  (click)="$event.stopPropagation(); onClickRefresh(folderForm)"
                ></div>
                <button
                  class="btn btn-danger btn-without-background"
                  [appTooltip]="
                    translations.folders.tooltips.deleteFolder | translate
                  "
                  (click)="
                    $event.stopPropagation();
                    openConfirmDeleteDialog(folderForm)
                  "
                >
                  <i class="icon-trash trash-btn"></i>
                </button>
              </div>
            </div>
          </mat-expansion-panel-header>
          <form [formGroup]="folderForm">
            <div *ngIf="folderForm.get('action').value === 'sign'">
              <mat-form-field>
                <mat-select
                  class="custom-select"
                  formControlName="identity"
                  name="identity"
                  placeholder="Identity to use"
                >
                  <mat-option
                    *ngFor="
                      let identityName of identityService.arrayIdentityContent
                    "
                    [value]="identityName.name"
                  >
                    {{ identityName.name }}
                  </mat-option>
                </mat-select>
                <mat-error
                  *ngIf="identityService.arrayIdentityContent.length === 0"
                >
                  {{
                    translations.folders.errors.addAtLeastOneIdentity
                      | translate
                  }}
                </mat-error>
                <mat-error
                  *ngIf="
                    identityService.arrayIdentityContent.length !== 0 &&
                    folderForm.get('identity').getError('voidIdentity')
                  "
                >
                  {{ translations.folders.errors.identityRequired | translate }}
                </mat-error>
                <mat-error
                  *ngIf="
                    folderForm.get('identity').getError('identityNotFound')
                  "
                >
                  {{ translations.folders.errors.notFound | translate }}
                </mat-error>
              </mat-form-field>
            </div>
            <div
              *ngIf="
                folderForm.get('action').value ===
                folderFormGroup.get('action').value
              "
            >
              <div>
                <mat-checkbox
                  color="primary"
                  name="public"
                  formControlName="public"
                >
                  {{
                    translations.folders.checkbox.makeProofsPublicly | translate
                  }}
                </mat-checkbox>
              </div>
              <div>
                <mat-checkbox
                  color="primary"
                  name="recursive"
                  formControlName="recursive"
                >
                  {{
                    translations.folders.checkbox.includeFilesFromSubfolders
                      | translate
                  }}
                </mat-checkbox>
              </div>
              <div>
                <mat-checkbox
                  color="primary"
                  name="strict"
                  formControlName="strict"
                >
                  {{ translations.folders.checkbox.recreateProofs | translate }}
                </mat-checkbox>
              </div>
              <div>
                <mat-checkbox
                  color="primary"
                  name="prune"
                  formControlName="prune"
                >
                  {{
                    translations.folders.checkbox.deleteOldProofs | translate
                  }}
                </mat-checkbox>
              </div>
              <div *ngIf="folderForm.get('action').value === 'sign'">
                <mat-checkbox
                  color="primary"
                  name="iDServerUnsecureSSL"
                  formControlName="iDServerUnsecureSSL"
                >
                  {{
                    translations.folders.checkbox.notCheckSSLCertificate
                      | translate
                  }}
                </mat-checkbox>
              </div>
              <div>
                <mat-form-field class="full-width">
                  <mat-label>{{
                    translations.folders.proveFilesMatchingRegularExpression
                      | translate
                  }}</mat-label>
                  <input
                    matInput
                    class="form-control"
                    type="text"
                    name="filter"
                    formControlName="filter"
                  />
                </mat-form-field>
              </div>
            </div>
            <div>
              <button
                class="btn btn-primary mr"
                (click)="onClickFixReceipts(folderForm)"
              >
                {{ translations.folders.fixReceipts | translate }}
              </button>
              {{ translations.folders.renameOldReceiptsAndFix | translate }}
            </div>
            <span class="span-update-configuration">
              <button
                class="btn btn-primary"
                [disabled]="folderForm.pristine || folderForm.invalid"
                (click)="onClickUpdateFolderOptions(folderForm)"
              >
                {{ translations.folders.updateConfig | translate }}
              </button>
            </span>
          </form>
        </mat-expansion-panel>
      </ng-container>
    </mat-accordion>
  </div>
</div>
