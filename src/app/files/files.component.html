<div>
  <mat-card class="full-size-card">
    <mat-tab-group
      class="action-tab"
      (selectedIndexChange)="onTabChange($event)"
    >
      <mat-tab [label]="'Fichier à horodater'"> </mat-tab>
      <mat-tab [label]="'Fichier à certifier'"> </mat-tab>
    </mat-tab-group>
    <div *ngIf="!fileHash" class="default-text">
      Déposez ici les fichiers pour lesquels vous souhaitez créer une preuve
      d'horodatage. Une fois les fichiers ancrés dans la blockchain Bitcoin,
      vous pourrez télécharger les reçus de preuve à partir de votre tableau de
      bord. Ces reçus de preuve vous permettront de prouver l'existence de vos
      fichiers à la date de l'horodatage.

      <!-- Drag and drop file to hash -->

      <div
        class="dropzone"
        appDragDrop
        (fileDropped)="onFileDropped($event)"
        (startDropping)="isDroppingAFile = true"
        (stopDropping)="isDroppingAFile = false"
      >
        <input
          #fileInput
          type="file"
          (change)="onSelectedFile($event); fileInput.value = null"
          class="dropzone-file-input"
          [ngClass]="{ 'not-clickable': isHashing }"
        />
        <div *ngIf="!isHashing">
          <mat-icon class="drop-icon">note_add</mat-icon>
          <div class="drop-text">Déposez votre fichier ici</div>
        </div>

        <div *ngIf="isHashing">
          <img src="assets/images/loading-woleet-api.svg" />
          <div class="hash-progress">{{ progress | percent }}</div>
          <div class="hash-text"><em>Calcul du hash…</em></div>
          <button
            mat-raised-button
            color="warn"
            (click)="cancelFileHash()"
            class="cancel-file-hash"
          >
            {{ translations.commons.buttons.cancel | translate }}
          </button>
        </div>
      </div>
    </div>
    <form [formGroup]="fileFormGroup" *ngIf="fileHash">
      <mat-form-field *ngIf="fileFormGroup.get('action').value == 'sign'">
        <mat-label>{{
          translations.folders.identityToUse | translate
        }}</mat-label>
        <mat-select
          class="custom-select"
          formControlName="identity"
          name="identity"
        >
          <mat-option
            *ngFor="let identityName of identityService.arrayIdentityContent"
            [value]="identityName.name"
          >
            {{ identityName.name }}
          </mat-option>
        </mat-select>
        <mat-error *ngIf="identityService.arrayIdentityContent.length === 0">
          {{ translations.folders.errors.addAtLeastOneIdentity | translate }}
        </mat-error>
        <mat-error
          *ngIf="
            identityService.arrayIdentityContent.length !== 0 &&
            fileFormGroup.get('identity').getError('voidIdentity')
          "
        >
          {{ translations.folders.errors.identityRequired | translate }}
        </mat-error>
        <mat-error
          *ngIf="fileFormGroup.get('identity').getError('identityNotFound')"
        >
          {{ translations.folders.errors.notFound | translate }}
        </mat-error>
      </mat-form-field>

      <mat-form-field class="full-width">
        <mat-label>Nom</mat-label>
        <input matInput type="text" formControlName="name" />
      </mat-form-field>

      <mat-form-field class="full-width">
        <mat-label>Tags</mat-label>
        <mat-chip-list #chipList>
          <mat-chip *ngFor="let tag of tags" (removed)="removeTag(tag)">
            {{ tag }}
            <button matChipRemove>
              <mat-icon>cancel</mat-icon>
            </button>
          </mat-chip>
          <input
            placeholder="Nouveau tag..."
            [matChipInputFor]="chipList"
            [matChipInputSeparatorKeyCodes]="separatorKeysCodes"
            [matChipInputAddOnBlur]="addOnBlur"
            (matChipInputTokenEnd)="addTag($event)"
          />
        </mat-chip-list>
      </mat-form-field>

      <mat-form-field
        *ngIf="fileFormGroup.get('action').value == 'sign'"
        class="full-width"
      >
        <mat-label>URL d'identité</mat-label>
        <input matInput type="text" formControlName="identityURL" />
      </mat-form-field>

      <mat-checkbox color="primary" name="public" formControlName="public">
        Public
      </mat-checkbox>
      <div class="accordion-section">
        <mat-accordion>
          <mat-expansion-panel
            (opened)="openCallbackURLPanel = true"
            (closed)="openCallbackURLPanel = false"
          >
            <mat-expansion-panel-header>
              <mat-panel-title>URL de callback</mat-panel-title>
            </mat-expansion-panel-header>

            <mat-form-field class="full-width">
              <mat-label>URL</mat-label>
              <input matInput type="text" formControlName="callbackURL" />
            </mat-form-field>
            <button
              type="button"
              mat-raised-button
              color="primary"
              class="span-folder-add-button"
              [disabled]="!fileFormGroup.get('callbackURL').value"
              (click)="testCallbackURL()"
            >
              Tester l'URL
            </button>

            <!-- Result of an anchor callback -->
            <mat-card
              *ngIf="anchorCallbackResult"
              class="test-url-response"
              [ngClass]="
                anchorCallbackResult.status >= 200 &&
                anchorCallbackResult.status <= 299
                  ? 'success'
                  : 'error'
              "
            >
              <div *ngIf="!!anchorCallbackResult.status">
                Statut : {{ anchorCallbackResult.status }}
              </div>
              <div *ngIf="!!anchorCallbackResult.message">
                Contenu : {{ anchorCallbackResult.message }}
              </div>
            </mat-card>
          </mat-expansion-panel>
        </mat-accordion>
      </div>
      <div class="accordion-section">
        <mat-accordion>
          <mat-expansion-panel
            (opened)="openMetadataPanel = true"
            (closed)="openMetadataPanel = false"
          >
            <mat-expansion-panel-header>
              <mat-panel-title> Métadonnées </mat-panel-title>
            </mat-expansion-panel-header>
            <div class="metadata">
              <ul>
                <li *ngFor="let data of metadata | keyvalue">
                  <div class="key-value">
                    {{ data.key }}: {{ data.value }}
                    <mat-icon (click)="deleteMetadata(data.key)" class="delete">
                      delete
                    </mat-icon>
                  </div>
                </li>
              </ul>

              <div class="d-flex">
                <mat-form-field class="name">
                  <mat-label>Nom</mat-label>
                  <input
                    matInput
                    type="text"
                    formControlName="metadataName"
                    (keyup.enter)="metadataIsValid() ? addMetadata() : null"
                  />
                </mat-form-field>
                <mat-form-field class="value">
                  <mat-label>Valeur</mat-label>
                  <input
                    matInput
                    type="text"
                    formControlName="metadataValue"
                    (keyup.enter)="metadataIsValid() ? addMetadata() : null"
                  />
                </mat-form-field>
              </div>
              <button
                type="button"
                mat-raised-button
                color="primary"
                (click)="addMetadata()"
                [disabled]="!metadataIsValid()"
              >
                <mat-icon>add</mat-icon>
              </button>
            </div>
          </mat-expansion-panel>
        </mat-accordion>
      </div>
      <span class="align-end">
        <button
          type="button"
          mat-raised-button
          color="primary"
          class="span-folder-add-button"
          [disabled]="fileFormGroup.invalid"
          (click)="onClickTimestamp()"
        >
          Horodater le ficher
        </button>
        <button
          type="button"
          mat-raised-button
          color="warn"
          (click)="onCancelAddClick()"
        >
          {{ translations.commons.buttons.cancel | translate }}
        </button>
      </span>
    </form>
  </mat-card>
</div>
